# /infrastructure/nginx/nginx.conf

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Compressão Gzip para melhorar a velocidade de carregamento
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types application/javascript application/json application/xml text/css text/javascript text/plain text/xml;

    # Definição dos backends (microsserviços) - TODOS APONTANDO PARA LOCALHOST
    # As portas devem ser as mesmas que seus microsserviços Spring Boot estão configurados para rodar.
    upstream auth_service {
        server localhost:8081; # auth-service rodando localmente na porta 8081
    }

    upstream user_profile_service {
        server localhost:8082; # user-profile-service rodando localmente na porta 8082
    }

    upstream lawyer_profile_service {
        server localhost:8083; # lawyer-profile-service rodando localmente na porta 8083
    }

    upstream service_scheduling_service {
        server localhost:8084; # service-scheduling-service rodando localmente na porta 8084
    }

    upstream payment_subscription_service {
        server localhost:8085; # payment-subscription-service rodando localmente na porta 8085
    }

    upstream communication_lead_service {
        server localhost:8086; # communication-lead-service rodando localmente na porta 8086
    }

    upstream review_visit_service {
        server localhost:8087; # review-visit-service rodando localmente na porta 8087
    }

    upstream admin_platform_service {
        server localhost:8088; # admin-platform-service rodando localmente na porta 8088
    }

    upstream public_api_gateway {
        server localhost:8089; # public-api-gateway rodando localmente na porta 8089
    }

    # Servidor principal para o API Gateway
    server {
        listen 80; # Nginx escuta na porta 80

        # Para desenvolvimento, permita CORS para todos os origens
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';

        # Manipula requisições OPTIONS (preflight CORS)
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Roteamento dos Microsserviços para seus endereços locais
        location /auth/ {
            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /public/ {
            proxy_pass http://public_api_gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /users/ {
            proxy_pass http://user_profile_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /lawyers/ {
            proxy_pass http://lawyer_profile_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/ {
            proxy_pass http://service_scheduling_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /schedule/ {
            proxy_pass http://service_scheduling_service/agendamento/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /payments/ {
            proxy_pass http://payment_subscription_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /subscriptions/ {
            proxy_pass http://payment_subscription_service/plano/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /messages/ {
            proxy_pass http://communication_lead_service/mensagem/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /leads/ {
            proxy_pass http://communication_lead_service/lead/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /reviews/ {
            proxy_pass http://review_visit_service/avaliacao/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /visits/ {
            proxy_pass http://review_visit_service/visit/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /admin/ {
            proxy_pass http://admin_platform_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            return 200 'Nginx API Gateway is running!';
            add_header Content-Type text/plain;
        }
    }
}